From 414ef63e0608c0830c7d3d615653e751ccd6c7ae Mon Sep 17 00:00:00 2001
From: Erich <ec2624@nyu.edu>
Date: Sun, 17 Apr 2016 22:53:42 -0400
Subject: [PATCH] Add filesystem timestamps

---
 file.h    |  3 +++
 fs.c      |  3 +++
 fs.h      |  5 +++--
 ls.c      |  4 ++--
 mkfs.c    | 11 +++++++++++
 stat.h    |  3 ++-
 sysfile.c |  4 ++--
 7 files changed, 26 insertions(+), 7 deletions(-)

diff --git a/file.h b/file.h
index 5a4a463..82b09ae 100644
--- a/file.h
+++ b/file.h
@@ -1,3 +1,5 @@
+#include "date.h"
+
 struct file {
   enum { FD_NONE, FD_PIPE, FD_INODE } type;
   int ref; // reference count
@@ -22,6 +24,7 @@ struct inode {
   short nlink;
   uint size;
   uint addrs[NDIRECT+1];
+  struct rtcdate timestamp;
 };
 #define I_BUSY 0x1
 #define I_VALID 0x2
diff --git a/fs.c b/fs.c
index 025b326..df46e05 100644
--- a/fs.c
+++ b/fs.c
@@ -209,6 +209,7 @@ iupdate(struct inode *ip)
   dip->minor = ip->minor;
   dip->nlink = ip->nlink;
   dip->size = ip->size;
+  dip->timestamp = ip->timestamp;
   memmove(dip->addrs, ip->addrs, sizeof(ip->addrs));
   log_write(bp);
   brelse(bp);
@@ -286,6 +287,7 @@ ilock(struct inode *ip)
     ip->minor = dip->minor;
     ip->nlink = dip->nlink;
     ip->size = dip->size;
+    ip->timestamp = dip->timestamp;
     memmove(ip->addrs, dip->addrs, sizeof(ip->addrs));
     brelse(bp);
     ip->flags |= I_VALID;
@@ -427,6 +429,7 @@ stati(struct inode *ip, struct stat *st)
   st->type = ip->type;
   st->nlink = ip->nlink;
   st->size = ip->size;
+  st->timestamp = ip->timestamp;
 }
 
 //PAGEBREAK!
diff --git a/fs.h b/fs.h
index e1d7d09..3f4eddb 100644
--- a/fs.h
+++ b/fs.h
@@ -1,6 +1,6 @@
 // On-disk file system format. 
 // Both the kernel and user programs use this header file.
-
+#include "date.h"
 
 #define ROOTINO 1  // root i-number
 #define BSIZE 512  // block size
@@ -31,7 +31,8 @@ struct dinode {
   short minor;          // Minor device number (T_DEV only)
   short nlink;          // Number of links to inode in file system
   uint size;            // Size of file (bytes)
-  uint addrs[NDIRECT+1];   // Data block addresses
+  uint addrs[NDIRECT+11];   // Data block addresses
+  struct rtcdate timestamp;
 };
 
 // Inodes per block.
diff --git a/ls.c b/ls.c
index b6ddd7f..c51dee2 100644
--- a/ls.c
+++ b/ls.c
@@ -43,7 +43,7 @@ ls(char *path)
   
   switch(st.type){
   case T_FILE:
-    printf(1, "%s %d %d %d\n", fmtname(path), st.type, st.ino, st.size);
+    printf(1, "%s %d %d %d %d/%d/%d %d:%d:%d\n", fmtname(path), st.type, st.ino, st.size, st.timestamp.month, st.timestamp.day, st.timestamp.year, st.timestamp.hour, st.timestamp.minute, st.timestamp.second);
     break;
   
   case T_DIR:
@@ -63,7 +63,7 @@ ls(char *path)
         printf(1, "ls: cannot stat %s\n", buf);
         continue;
       }
-      printf(1, "%s %d %d %d\n", fmtname(buf), st.type, st.ino, st.size);
+      printf(1, "%s %d %d %d %d/%d/%d %d:%d:%d\n", fmtname(buf), st.type, st.ino, st.size, st.timestamp.month, st.timestamp.day, st.timestamp.year, st.timestamp.hour, st.timestamp.minute, st.timestamp.second);
     }
     break;
   }
diff --git a/mkfs.c b/mkfs.c
index 0a10754..26020f3 100644
--- a/mkfs.c
+++ b/mkfs.c
@@ -4,6 +4,7 @@
 #include <string.h>
 #include <fcntl.h>
 #include <assert.h>
+#include <time.h>
 
 #define stat xv6_stat  // avoid clash with host struct stat
 #include "types.h"
@@ -225,11 +226,21 @@ ialloc(ushort type)
 {
   uint inum = freeinode++;
   struct dinode din;
+  time_t curr_time;
+  struct tm* info;
+  time(&curr_time);
+  info = gmtime(&curr_time);
 
   bzero(&din, sizeof(din));
   din.type = xshort(type);
   din.nlink = xshort(1);
   din.size = xint(0);
+  din.timestamp.second = info->tm_sec;
+  din.timestamp.minute = info->tm_min;
+  din.timestamp.hour = info->tm_hour;
+  din.timestamp.day = info->tm_mday;
+  din.timestamp.month = info->tm_mon;
+  din.timestamp.year = info->tm_year;
   winode(inum, &din);
   return inum;
 }
diff --git a/stat.h b/stat.h
index 8a80933..a3b346c 100644
--- a/stat.h
+++ b/stat.h
@@ -1,11 +1,12 @@
 #define T_DIR  1   // Directory
 #define T_FILE 2   // File
 #define T_DEV  3   // Device
-
+#include "date.h"
 struct stat {
   short type;  // Type of file
   int dev;     // File system's disk device
   uint ino;    // Inode number
   short nlink; // Number of links to file
   uint size;   // Size of file in bytes
+  struct rtcdate timestamp;
 };
diff --git a/sysfile.c b/sysfile.c
index 2209f6e..fdeccc5 100644
--- a/sysfile.c
+++ b/sysfile.c
@@ -241,7 +241,6 @@ create(char *path, short type, short major, short minor)
   uint off;
   struct inode *ip, *dp;
   char name[DIRSIZ];
-
   if((dp = nameiparent(path, name)) == 0)
     return 0;
   ilock(dp);
@@ -263,7 +262,8 @@ create(char *path, short type, short major, short minor)
   ip->minor = minor;
   ip->nlink = 1;
   iupdate(ip);
-
+  
+  cmostime(&(ip->timestamp));
   if(type == T_DIR){  // Create . and .. entries.
     dp->nlink++;  // for ".."
     iupdate(dp);
-- 
1.9.1

